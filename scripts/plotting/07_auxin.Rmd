---
title: "Auxin analysis"
author: "Marco Stock"
---

## Setup
```{r include = FALSE}
library(here)
knitr::opts_knit$set(root.dir = here::here())
```
```{r, message = FALSE}
source("scripts/utils.R")
source("scripts/settings.R")
```

## Load data
```{r}
load("data/processed/genome.RData")
load("data/processed/rna_dynamics.RData")
load("data/processed/chip_dynamics.RData")

auxin_dir <- "data/raw/auxin/"
se_1_2 <- readRDS(paste0(auxin_dir, "se_kal_reps_1_2.rds"))
se_3_4 <- readRDS(paste0(auxin_dir, "se_kal_reps_3_4.rds"))

mapnames <- se_1_2@elementMetadata@listData$name
names(mapnames) <- se_1_2@elementMetadata@listData$id
```

## Preprocessing
```{r}
remove_sustained <- FALSE
timepoints_unified <- c("T1" = "256c+1hr", "T2" = "256c+2hr", "T3" = "256c+3hr")

preprocess_se <- function(se) {
    se <- se[, !grepl("Wt", se@colData@listData$condition)]
    se <- se[mapnames[rownames(se)] %in% c(rna_dyns$GZ, rna_dyns$ZS), ]
    if (remove_sustained) {
        se <- se[, !grepl("-IAA", se@colData@listData$condition)]
    }
    se@colData@listData$group <-
        sapply(se@colData@listData$FID_comment, function(x) {
            parts <- unlist(strsplit(x, " "))
            condition <- gsub(" ", "", paste(parts[1:(grep("IAA", parts))], collapse = " "))
            timepoint <- timepoints_unified[grep("T[1-3]", parts, value = TRUE)]
            replicate <- grep("\\b[1-4]\\.[1-3]\\b", parts, value = TRUE)
            paste0(condition, " ", timepoint, " Rep ", replicate)
        })

    return(se)
}

se_1_2 <- preprocess_se(se_1_2)
se_3_4 <- preprocess_se(se_3_4)

controls <- c("Control-IAA" = "Control-IAA", "Control+IAA" = "Control+IAA", "Treated-IAA" = "Control-IAA", "Treated+IAA" = "Control+IAA")
de_filename <- function(dir, rep, timepoint, condition) {
    paste0(dir, "res_", rep, "_", timepoint, "_Treated_", condition, "_", timepoint, "_vs_Control_", condition, "_", timepoint, ".rds")
}
```

## Violin comparison of fold change
```{r warning=FALSE}
for (rep in 2:3) {
    if (rep %in% c(1, 2)) {
        se <- se_1_2
    } else {
        se <- se_3_4
    }
    se_rep <- se[, se@colData@listData$experiment_set == rep]
    tpms_norm <- normalize_tpms(se_rep, controls)
    for (dyn in c("Kept", "Gained")) {
        tpms_norm_dyn <- subset_dynamics(tpms_norm, dyn)
        for (tp in 1:3) {
            tpms_norm_dyn_tp <- subset_tp(tpms_norm_dyn, tp)
            for (condition in c("mIAA", "pIAA")) {
                if (condition == "mIAA") {
                    cols <- c("#7BC5CD", "#CE5C46")
                    order <- c("Control-IAA", "Treated-IAA")
                } else if(condition == "pIAA") {
                    cols <- c("#54868B", "#8C3F30")
                    order <- c("Control+IAA", "Treated+IAA")
                }

                violin <- plot_violin(tpms_norm_dyn_tp,
                    cols = cols,
                    order = order,
                    comparisons = list(rev(order)),
                    y_max = 2.5,
                    title = paste0(dyn, " & Zygotic (T", tp, ")")
                )
                plot(violin)
                ggsave(paste0("output/auxin/violin_zygotic_rep", rep, "_", dyn, "_t", tp, "_", condition, ".pdf"), width = 3, height = 4)
            }
        }
    }
}
```

## Heatmaps of fold change
```{r warning=FALSE}
for (rep in 2:3) {
    if (rep %in% c(1, 2)) {
        se <- se_1_2
    } else {
        se <- se_3_4
    }
    se_rep <- se[, se@colData@listData$experiment_set == rep]
    tpms_norm <- normalize_tpms(se_rep, controls)

    hm <- plot_heatmap(tpms_norm,
        order = c("Control-IAA", "Control+IAA", "Treated-IAA", "Treated+IAA"),
        hm_rows = "chip_dyns",
        de_list = get_de_list(auxin_dir, rep,
            de_timepoints <- c("T1", "T2", "T3"),
            de_conditions <- c("mIAA", "pIAA"),
            background = rownames(tpms_norm)
        ),
        only_de = FALSE
    )
    draw(hm)

    pdf(paste0("output/auxin/heatmap_zygotic_rep", rep, ".pdf"), width = 10, height = 5)
    draw(hm)
    dev.off()
}
```

## Balloon plots of zygotic genes
```{r warning=FALSE}
tps <- c("T1", "T2", "T3")
conditions <- c("mIAA", "pIAA")

for (rep in 2:3) {
    for (tp in tps) {
        for (dyns in c("detail", "rna_timing")) {
            for (condition in conditions) {
                de_list <- get_de_list(auxin_dir, rep,
                    de_timepoints <- tp,
                    de_conditions <- condition,
                    background = unique(unlist(chip_dyns))
                )
                if (dyns == "chip") {
                    comp_dyns <- lapply(chip_dyns[names(chip_dyns) %in% c("Kept", "Gained", "Absent")], function(x) intersect(x, c(rna_dyns$GZ, rna_dyns$ZS)))
                    names(comp_dyns) <- paste(names(comp_dyns), "& Zygotic")
                } else if (dyns == "rna") {
                    comp_dyns <- rna_dyns[names(rna_dyns) %in% c("GZ", "ZS")]
                } else if (dyns == "detail") {
                    comp_dyns <- list()
                    for (chip_dyn in c("Kept", "Gained", "Absent")) {
                        for (rna_dyn in c("GZ", "ZS")) {
                            intersection_name <- paste(chip_dyn, rna_dyn, sep = " & ")
                            comp_dyns[[intersection_name]] <- intersect(chip_dyns[[chip_dyn]], rna_dyns[[rna_dyn]])
                        }
                    }
                } else if (dyns == "rna_timing") {
                    comp_dyns <- rna_dyns_timing
                }

                plot_balloonplot(x_dyns = comp_dyns, y_dyns = de_list, limit = 200, x_caption = paste(dyns, "dynamics"), y_caption = "RNA expression")
                ggsave(paste0("output/auxin/balloon_plot_zygotic_rep", rep, "_", dyns, "_", tp, "_", condition, ".pdf"), width = 4, height = 4)
            }
        }
    }
}
```

## Balloon plots of downregulated genes
```{r warning=FALSE}
de_timepoints <- c("T1", "T2", "T3")
de_conditions <- c("mIAA", "pIAA")
files <- expand.grid(timepoint = de_timepoints, condition = de_conditions)

for (rep in 2:3) {
    down_lists <- lapply(1:nrow(files), read_de_res, direction = "down", files = files, dir = auxin_dir, rep = rep)
    names(down_lists) <- paste(files$condition, files$timepoint)

    overlap_dyns <- list(
        "T1" = list("only persistant" = setdiff(down_lists[["mIAA T1"]], down_lists[["pIAA T1"]]), "both conditions" = intersect(down_lists[["mIAA T1"]], down_lists[["pIAA T1"]]), "only window" = setdiff(down_lists[["pIAA T1"]], down_lists[["mIAA T1"]])),
        "T2" = list("only persistant" = setdiff(down_lists[["mIAA T2"]], down_lists[["pIAA T2"]]), "both conditions" = intersect(down_lists[["mIAA T2"]], down_lists[["pIAA T2"]]), "only window" = setdiff(down_lists[["pIAA T2"]], down_lists[["mIAA T2"]])),
        "T3" = list("only persistant" = setdiff(down_lists[["mIAA T3"]], down_lists[["pIAA T3"]]), "both conditions" = intersect(down_lists[["mIAA T3"]], down_lists[["pIAA T3"]]), "only window" = setdiff(down_lists[["pIAA T3"]], down_lists[["mIAA T3"]]))
    )

    for (tp in c("T1", "T2", "T3")) {
        for (dyns in c("detail", "rna_timing")) {
            if (dyns == "chip") {
                comp_dyns <- lapply(chip_dyns[names(chip_dyns) %in% c("Kept", "Gained", "Absent")], function(x) intersect(x, c(rna_dyns$GZ, rna_dyns$ZS)))
                names(comp_dyns) <- paste(names(comp_dyns), "& Zygotic")
            } else if (dyns == "rna") {
                comp_dyns <- rna_dyns[names(rna_dyns) %in% c("GZ", "ZS")]
            } else if (dyns == "detail") {
                comp_dyns <- list()
                for (chip_dyn in c("Kept", "Gained", "Absent")) {
                    for (rna_dyn in c("GZ", "ZS")) {
                        intersection_name <- paste(chip_dyn, rna_dyn, sep = " & ")
                        comp_dyns[[intersection_name]] <- intersect(chip_dyns[[chip_dyn]], rna_dyns[[rna_dyn]])
                    }
                }
            } else if (dyns == "rna_timing") {
                comp_dyns <- rna_dyns_timing
            }

            plot_balloonplot(x_dyns = comp_dyns, y_dyns = overlap_dyns[[tp]], limit = 200, x_caption = paste(dyns, "dynamics"), y_caption = "Downregulated genes")
            ggsave(paste0("output/auxin/balloon_plot_down_rep", rep, "_", dyns, "_", tp, ".pdf"), width = 4, height = 4)
        }
    }
}
```

## Balloon plots of zygotic timing
```{r warning=FALSE}
tps <- c("T1", "T2", "T3")
conditions <- c("mIAA", "pIAA")

for (rep in 2:3) {
    for (tp in tps) {
        for (condition in conditions) {
            de_list <- get_de_list(auxin_dir, rep,
                de_timepoints <- tp,
                de_conditions <- condition,
                background = unique(unlist(chip_dyns))
            )

            comp_dyns <- lapply(chip_dyns[names(chip_dyns) %in% c("Kept", "Gained", "Absent")], function(x) intersect(x, c(rna_dyns$GZ, rna_dyns$ZS)))
            comp_dyns <- lapply(comp_dyns, function(x) intersect(x, de_list$down))
            names(comp_dyns) <- paste(names(comp_dyns), "& Zygotic")

            plot_balloonplot(x_dyns = rna_dyns_timing, y_dyns = comp_dyns, limit = 200, x_caption = "RNA timing", y_caption = "Dynamics")
            ggsave(paste0("output/auxin/balloon_plot_timing_rep", rep, "_", tp, "_", condition, ".pdf"), width = 4, height = 4)
        }
    }
}
```