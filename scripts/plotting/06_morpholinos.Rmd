---
title: "Morpholinos analysis"
author: "Marco Stock"
---

## Setup
```{r include = FALSE}
library(here)
knitr::opts_knit$set(root.dir = here::here())
```
```{r, message = FALSE}
source("scripts/utils.R")
source("scripts/settings.R")
```

## Load data
```{r}
load("data/processed/rna_dynamics.RData")
load("data/processed/chip_dynamics.RData")

morpholino_dir <- "data/raw/morpholinos/"
se <- readRDS(paste0(morpholino_dir, "se_kal.rds"))

mapnames <- se@elementMetadata@listData$name
names(mapnames) <- se@elementMetadata@listData$id
```

## Preprocessing
```{r}
se <- se[, !grepl("Wdr5", se@colData@listData$group)]
se <- se[, !grepl("256c Rep", se@colData@listData$group)]

se@colData@listData$group <- sapply(se@colData@listData$group, function(x) {
    words <- unlist(strsplit(x, " "))
    paste(words[-2], collapse = " ")
})

# Zygotic genes only
se <- se[mapnames[rownames(se)] %in% c(rna_dyns$GZ, rna_dyns$ZS), ]

controls <- c("Cxxc1" = "Ctrl", "Ctrl" = "Ctrl", "Kmt2b" = "Ctrl", "NI" = "Ctrl")
de_filename <- function(dir, rep, timepoint, condition) {
    paste0(dir, "res__", rep, "_", timepoint, "_", condition, "_MO_", timepoint, "_vs_Ctrl_MO_", timepoint, ".rds")
}
```

## Violin comparison of fold change
```{r warning=FALSE}
for (rep in c("I", "II")) {
    se_rep <- se[, sapply(se@colData@listData$group, function(x) regmatches(x, regexpr("\\b(I{1,3})\\b", x))) == rep]
    tpms_norm <- normalize_tpms(se_rep, controls)
    for (dyn in c("Kept", "Gained")) {
        tpms_norm_dyn <- subset_dynamics(tpms_norm, dyn)
        for (tp in 1:3) {
            tpms_norm_dyn_tp <- subset_tp(tpms_norm_dyn, tp)
            violin <- plot_violin(tpms_norm_dyn_tp,
                cols = c("#E1DCC9", "#17395C", "#EFB758"),
                order = c("Ctrl", "Cxxc1", "Kmt2b"),
                comparisons = list(c("Kmt2b", "Ctrl"), c("Cxxc1", "Ctrl")),
                y_max = 3,
                title = paste0(dyn, " & Zygotic (T", tp, ")")
            )
            plot(violin)
            ggsave(paste0("output/morpholinos/violin_zygotic_rep", rep, "_", dyn, "_t", tp, ".pdf"), width = 5, height = 4)
        }
    }
}
```

## Heatmaps of fold change
```{r warning=FALSE}
for (rep in c("I", "II")) {
    se_rep <- se[, sapply(se@colData@listData$group, function(x) regmatches(x, regexpr("\\b(I{1,3})\\b", x))) == rep]
    tpms_norm <- normalize_tpms(se_rep, controls)

    hm <- plot_heatmap(tpms_norm,
        order = c("NI", "Ctrl", "Cxxc1", "Kmt2b"),
        hm_rows = "chip_dyns",
        de_list = get_de_list(morpholino_dir, rep,
            de_timepoints <- c("1hr", "2hr", "3hr"),
            de_conditions <- c("Cxxc1", "Kmt2b"),
            background = rownames(tpms_norm)
        ),
        only_de = FALSE
    )
    draw(hm)

    pdf(paste0("output/morpholinos/heatmap_zygotic_rep", rep, ".pdf"), width = 10, height = 5)
    draw(hm)
    dev.off()
}
```

## Balloon plots of zygotic genes
```{r warning=FALSE}
tps <- c("1hr", "2hr", "3hr")
conditions <- c("Cxxc1", "Kmt2b")

for (rep in c("I", "II")) {
    for (tp in tps) {
        for (dyns in c("chip", "rna", "detail", "rna_timing")) {
            for (condition in conditions) {
                de_list <- get_de_list(morpholino_dir, rep,
                    de_timepoints <- tp,
                    de_conditions <- condition,
                    background = unique(unlist(chip_dyns))
                )
                if (dyns == "chip") {
                    comp_dyns <- lapply(chip_dyns[names(chip_dyns) %in% c("Kept", "Gained", "Absent")], function(x) intersect(x, c(rna_dyns$GZ, rna_dyns$ZS)))
                    names(comp_dyns) <- paste(names(comp_dyns), "& Zygotic")
                } else if (dyns == "rna") {
                    comp_dyns <- rna_dyns[names(rna_dyns) %in% c("GZ", "ZS")]
                } else if (dyns == "detail") {
                    comp_dyns <- list()
                    for (chip_dyn in c("Kept", "Gained", "Absent")) {
                        for (rna_dyn in c("GZ", "ZS")) {
                            intersection_name <- paste(chip_dyn, rna_dyn, sep = " & ")
                            comp_dyns[[intersection_name]] <- intersect(chip_dyns[[chip_dyn]], rna_dyns[[rna_dyn]])
                        }
                    }
                } else if(dyns == "rna_timing"){
                    comp_dyns <- rna_dyns_timing
                }

                plot_balloonplot(x_dyns = comp_dyns, y_dyns = de_list, limit = 200, x_caption = paste(dyns, "dynamics"), y_caption = "RNA expression")
                ggsave(paste0("output/morpholinos/balloon_plot_zygotic_rep", rep, "_", dyns, "_", tp, "_", condition, ".pdf"), width = 4, height = 4)
            }
        }
    }
}
```