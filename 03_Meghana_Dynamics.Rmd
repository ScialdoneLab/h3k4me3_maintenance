---
title: "Meghana H3K4me3 Maintenance - 03 Dynamics analysis"
output: html_notebook
---

##Load categories
```{r}
clustered_groups = TRUE
groups = "rna"

if(clustered_groups){
  load("rna_data_clustered.RData")
  load("chip_data_clustered.RData")
} else {
  load("rna_data.RData")
  load("chip_data.RData")
}
load("h3k4me3_data_sperm_Oikawa.RData")
```

## Balloon plot
```{r message=FALSE, warning=FALSE}
library(ggpubr)

plot_balloonplot <- function(remove_ND_NNNN){

  rna_ordered <- rna_dyns
  chip_ordered <- chip_dyns
  if(!clustered_groups){
    rna_ordered <- rna_dyns[c("Monly", "Ponly", "MPonly", "MZonly", "PZonly", "MPZ", "Zonly", "ND")]
    chip_ordered <- chip_dyns[c("Y_N_N_N", "N_Y_N_N",  "Y_Y_N_N", "Y_N_Y_N", "N_Y_Y_N", "Y_Y_Y_N", "Y_N_N_Y", "Y_Y_N_Y", "Y_N_Y_Y", "N_Y_Y_Y", "Y_Y_Y_Y","N_Y_N_Y",  "N_N_Y_Y", "N_N_Y_N", "N_N_N_Y", "N_N_N_N")]
  }
  if(remove_ND_NNNN){
    rna_ordered <- rna_ordered[!names(rna_ordered) %in% c("ND")]
    chip_ordered <- chip_ordered[!names(chip_ordered) %in% c("N_N_N_N", "Absent")]
  }
  
  genesAbsolute <- lapply(chip_ordered, function(x){as.data.frame(lapply(rna_ordered, function(y){length(intersect(x, y))}))})
  genesAbsolute <- do.call(rbind, genesAbsolute)
  
  fisher_p <- function(row, column){
    mat = genesAbsolute
    fisher_mat <- matrix(c(mat[row, column], sum(mat[-row, column]), sum(mat[row, -column]), sum(mat[-row, -column])), nrow=2)
    p_val <- fisher.test(fisher_mat)$p.value
    return(max(p_val, (1e-300)))
  }
  
  p_mat = data.frame(matrix(NA, nrow = nrow(genesAbsolute), ncol = ncol(genesAbsolute)), row.names = rownames(genesAbsolute))
  colnames(p_mat) = colnames(genesAbsolute)
  
  for (row in 1:nrow(p_mat)){
    for (col in 1:ncol(p_mat)){
      p_mat[row, col] <- fisher_p(row, col)
    }
  }
  
  p_mat = -log10(p_mat)
  
  ## Sort by similarity
  #p_mat[p_mat < (-log10(0.05))] <- 0
  #h3k4me3_dist<-dist(p_mat, method="euclidean")
  #h3k4me3_clust<-hclust(h3k4me3_dist, method='complete')
  
  #rna_dist<-dist(t(p_mat), method="euclidean")
  #rna_clust<-hclust(rna_dist, method='complete')
  
  #p_mat <- p_mat[h3k4me3_clust$order, rna_clust$order]
  
  p_mat[p_mat < (-log10(0.05))] <- NA
  #p_mat <- p_mat[rowSums(is.na(p_mat)) != ncol(p_mat), ] # remove empty rows
  #p_mat <- p_mat[!rownames(p_mat) %in% c("N_N_N_N", "Absent"), colnames(p_mat) != "ND"] # not-detected does not mean not expressed (very uncertain sets)
  
  my_cols <- c("#6A00A8FF", "#FCA636FF", "#F0F921FF", "#F0F921FF")
  ggballoonplot(p_mat, fill="value") +
                        theme_light() + labs(x="RNA expression dynamics", y=paste0("H3K4me3 TSS dynamics\n", "[Spermatid, Sperm, Pre-ZGA, ZGA]")) +
                        scale_fill_gradientn(colors = my_cols, values=c(0, 0.05, 0.5, 1), breaks=c(0, 2, 20, 50, 100, 200)) + guides(size=guide_legend(title="-log10(Fisher independence p value)"), fill=guide_legend(title="-log10(Fisher independence p value)")) + scale_size(range = c(0, 10), breaks =c(0, 2, 20, 50, 100, 200))
}

#plot_balloonplot(remove_ND_NNNN = FALSE)
plot_balloonplot(remove_ND_NNNN = TRUE)

```
```{r fig.height=10, fig.width=15}
library(ComplexUpset)
rna_small <- rna_dyns[!names(rna_dyns) %in% c("ND")]
chip_small <- chip_dyns[!names(chip_dyns) %in% c("N_N_N_N", "Absent")]
genes_of_interest <- unique(c(unlist(rna_small), unlist(chip_small)))
cols = lapply(c(rna_small, chip_small), function(dyn) genes_of_interest %in% dyn)
df <- data.frame(cols)
metadata <- data.frame(set = c(names(rna_small), names(chip_small)), type = c(rep("rna", length(rna_small)), rep("chip", length(chip_small))))
upset(
    df,
    colnames(df),
    name="dynamic",
    width_ratio=0.15,
    stripes=upset_stripes(
        mapping=aes(color=type),
        colors=c(
            'rna'='green',
            'chip'='orange'
        ),
        data=metadata
    )
)
```


# Peak shape comparison
```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
library(reshape2)
library(ggpubr)

label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}
plot_peak <- function(name, groups){
  if(groups=="rna"){
    dyn = rna_dyns
    cols = cols_rnadyns
  } else if(groups=="chip"){
    dyn = chip_dyns
    cols = cols_chipdyns
  }
  stage_raw <- data.frame(chip_norm_mats[[paste(name)]])
  stage_raw$dyn <- sapply(rownames(stage_raw), label_dyn, dyns = dyn)
  stage_raw$gene <- rownames(stage_raw)
  melted <- melt(stage_raw)
  colnames(melted) <- c("dynamics", "Gene", "Genomic location", "Coverage")
  plot <- ggline(melted, x = "Genomic location", y = "Coverage",
   add = "mean_se", conf.int = TRUE, color="dynamics") + scale_color_manual(values=cols) + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + labs(y=expression(log[2](coverage + 1)), x = "+/-1kb of TSS") + ggtitle(name)
}

line_plots <- lapply(stages, plot_peak, groups=groups)
g <- arrangeGrob(line_plots[[1]], line_plots[[2]], line_plots[[3]], line_plots[[4]], ncol=4)
ggsave(file=paste0(groups, "_line_plots.pdf"), g, width = 25, height = 4)
```

#Differences in Chip/RNA groups
```{r fig.height=5, fig.width=10}
plot_stage_dynamics <- function(timepoint, type, groups, onlypeaks=FALSE){
  if(groups == "rna"){
    cols = cols_rnadyns
    dyn = rna_dyns
  } else if(groups == "chip"){
    cols = cols_chipdyns
    dyn = chip_dyns
  }
  label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}
  plot_df <- chip_dfs[[timepoint]]
  if(onlypeaks){plot_df <- plot_df[plot_df$peak, ]}
  plot_df$genes <- rownames(plot_df)
  plot_df$dyn <- factor(sapply(plot_df$genes, label_dyn, dyns = dyn))
  #plot_df$dyn <- factor(sapply(plot_df$genes, label_dyn, dyns = chip_dyns), levels=c("Kept", "Recovered", "Lost@ZGA", "Lost@Pre-ZGA", "Lost@Sperm", "GainedEarly", "GainedLate"))
  plot_df$dyn <- factor(plot_df$dyn, levels = levels(reorder(plot_df$dyn, plot_df[,paste(type)], median, decreasing=TRUE)))
  violin_plot <- ggviolin(plot_df, x = "dyn", y = paste(type), fill = "dyn",
           add = "boxplot", add.params = list(fill = "white")) + scale_fill_manual(values=cols) + rotate_x_text(45) + guides(fill="none")
    #guides(fill = guide_legend(nrow = 2))
  ecdf_plot <- ggecdf(plot_df, x = paste(type), color = "dyn") + scale_colour_manual(values=cols) + guides(color = "none")
    #guides(color = guide_legend(nrow = 2)) 
  arrangeGrob(violin_plot, ecdf_plot, top=paste(timepoint), ncol=2) #grid.arrange for direct plotting
}

res_width = lapply(stages, plot_stage_dynamics, type="peak.width", groups)
#res_enrich = lapply(stages, plot_stage_dynamics, type="promoter.enrich", groups)
res_mean = lapply(stages, plot_stage_dynamics, type="promoter.mean", groups)
#res_max = lapply(stages, plot_stage_dynamics, type="promoter.max", groups)

g <- arrangeGrob(res_width[[1]], res_width[[2]], res_width[[3]], res_width[[4]], 
                 res_mean[[1]], res_mean[[2]], res_mean[[3]], res_mean[[4]],
                  #res_enrich[[1]], res_enrich[[2]], res_enrich[[3]], res_enrich[[4]],
                  #res_max[[1]], res_max[[2]], res_max[[3]], res_max[[4]],
                  ncol=4)
ggsave(file=paste0(groups, "_dynamics.pdf"), g, width = 25, height = 6)
```

