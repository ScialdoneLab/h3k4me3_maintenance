---
title: "Meghana H3K4me3 Maintenance - 03 Dynamics analysis"
output: html_notebook
---

##Load categories
```{r}
clustered_groups = FALSE

if(clustered_groups){
  load("rna_data_clustered.RData")
  load("chip_data_clustered.RData")
} else {
  load("rna_data.RData")
  load("chip_data.RData")
}
load("h3k4me3_data_sperm_Oikawa.RData")
```

## Balloon plot
```{r message=FALSE, warning=FALSE}
library(ggpubr)

plot_balloonplot <- function(remove_ND_NNNN){

  rna_ordered <- rna_dyns
  chip_ordered <- chip_dyns
  if(!clustered_groups){
    rna_ordered <- rna_dyns[c("Monly", "Ponly", "MPonly", "MZonly", "PZonly", "MPZ", "Zonly", "ND")]
    chip_ordered <- chip_dyns[c("Y_N_N_N", "N_Y_N_N",  "Y_Y_N_N", "Y_N_Y_N", "N_Y_Y_N", "Y_Y_Y_N", "Y_N_N_Y", "Y_Y_N_Y", "Y_N_Y_Y", "N_Y_Y_Y", "Y_Y_Y_Y","N_Y_N_Y",  "N_N_Y_Y", "N_N_Y_N", "N_N_N_Y", "N_N_N_N")]
  }
  if(remove_ND_NNNN){
    rna_ordered <- rna_ordered[!names(rna_ordered) %in% c("ND")]
    chip_ordered <- chip_ordered[!names(chip_ordered) %in% c("N_N_N_N", "Absent")]
  }
  
  genesAbsolute <- lapply(chip_ordered, function(x){as.data.frame(lapply(rna_ordered, function(y){length(intersect(x, y))}))})
  genesAbsolute <- do.call(rbind, genesAbsolute)
  
  fisher_p <- function(row, column){
    mat = genesAbsolute
    fisher_mat <- matrix(c(mat[row, column], sum(mat[-row, column]), sum(mat[row, -column]), sum(mat[-row, -column])), nrow=2)
    p_val <- fisher.test(fisher_mat)$p.value
    return(max(p_val, (1e-300)))
  }
  
  p_mat = data.frame(matrix(NA, nrow = nrow(genesAbsolute), ncol = ncol(genesAbsolute)), row.names = rownames(genesAbsolute))
  colnames(p_mat) = colnames(genesAbsolute)
  
  for (row in 1:nrow(p_mat)){
    for (col in 1:ncol(p_mat)){
      p_mat[row, col] <- fisher_p(row, col)
    }
  }
  
  p_mat = -log10(p_mat)
  
  ## Sort by similarity
  #p_mat[p_mat < (-log10(0.05))] <- 0
  #h3k4me3_dist<-dist(p_mat, method="euclidean")
  #h3k4me3_clust<-hclust(h3k4me3_dist, method='complete')
  
  #rna_dist<-dist(t(p_mat), method="euclidean")
  #rna_clust<-hclust(rna_dist, method='complete')
  
  #p_mat <- p_mat[h3k4me3_clust$order, rna_clust$order]
  
  p_mat[p_mat < (-log10(0.05))] <- NA
  #p_mat <- p_mat[rowSums(is.na(p_mat)) != ncol(p_mat), ] # remove empty rows
  #p_mat <- p_mat[!rownames(p_mat) %in% c("N_N_N_N", "Absent"), colnames(p_mat) != "ND"] # not-detected does not mean not expressed (very uncertain sets)
  
  my_cols <- c("#6A00A8FF", "#FCA636FF", "#F0F921FF", "#F0F921FF")
  ggballoonplot(p_mat, fill="value") +
                        theme_light() + labs(x="RNA expression dynamics", y=paste0("H3K4me3 TSS dynamics\n", "[Spermatid, Sperm, Pre-ZGA, ZGA]")) +
                        scale_fill_gradientn(colors = my_cols, values=c(0, 0.05, 0.5, 1), breaks=c(0, 2, 20, 50, 100, 200)) + guides(size=guide_legend(title="-log10(Fisher independence p value)"), fill=guide_legend(title="-log10(Fisher independence p value)")) + scale_size(range = c(0, 10), breaks =c(0, 2, 20, 50, 100, 200))
}

plot_balloonplot(remove_ND_NNNN = FALSE)
plot_balloonplot(remove_ND_NNNN = TRUE)

```

# Peak shape comparison
```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
library(reshape2)

label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}
plot_peak <- function(name, groups){
  if(groups=="rna"){
    dyn = rna_dyns
    cols = cols_rnadyns
  } else if(groups=="chip"){
    dyn = chip_dyns
    cols = cols_chipdyns
  }
  stage_raw <- data.frame(chip_norm_mats[[paste(name)]])
  stage_raw$dyn <- sapply(rownames(stage_raw), label_dyn, dyns = dyn)
  stage_raw$gene <- rownames(stage_raw)
  melted <- melt(stage_raw)
  colnames(melted) <- c("dynamics", "Gene", "Genomic location", "Coverage")
  rna_plot <- ggline(melted, x = "Genomic location", y = "Coverage",
   add = "mean_se", conf.int = TRUE, color="dynamics") + scale_color_manual(values=cols) + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ggtitle(name)
}

lapply(stages, plot_peak, groups="rna")
lapply(stages, plot_peak, groups="chip")

```

#Overall peak analysis
```{r fig.height=5, fig.width=10}
library(ggpubr)
require(reshape2)
mask_peak <- function(df){
  df$promoter.enrich[!df$peak] <- NA
  df$promoter.max[!df$peak] <- NA
  df$promoter.mean[!df$peak] <- NA
  return(df)
}
preproc_df <- function(type){
  masked_dfs <- lapply(chip_dfs, mask_peak)
  plot_df <- do.call(cbind, masked_dfs)
  plot_df <- plot_df[, grep(type, colnames(plot_df))]
  plot_df$genes <- allgenes$gene_id
  plot_df <- melt(plot_df)
  colnames(plot_df) <- c("Gene","Stage", paste(type))  
  plot_df <- plot_df[!is.na(plot_df[,type]),]
  plot_df$Stage <- factor(plot_df$Stage, levels=levels(plot_df$Stage), labels=substr(levels(plot_df$Stage), 1, nchar(levels(plot_df$Stage))-nchar(type)-1))
  return(plot_df)
}

plot_distribution <- function(type){
  plot_df <- preproc_df(type)
  density_plot <- ggdensity(data=plot_df, x=paste(type), fill = "Stage", add_density = TRUE) #+ facet_wrap(~Stage)
  ecdf_plot <- ggecdf(data=plot_df, x=paste(type), color = "Stage") #+guides(colour = "none")
  grid.arrange(density_plot, ecdf_plot, ncol=2)
}

types = list("peak.width", "promoter.enrich", "promoter.mean", "promoter.max")
res <- lapply(types, plot_distribution)
```

#Differences in Chip groups
```{r fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}

plot_chip_diffs <- function(groups, type){
  if(groups == "rna"){
    cols = cols_rnadyns
    dyn = rna_dyns
  } else if(groups == "chip"){
    cols = cols_chipdyns
    dyn = chip_dyns
  }
  plot_df <- preproc_df(type)
  plot_df$dyn <- sapply(plot_df$Gene, label_dyn, dyns = dyn)
  #ggviolin(plot_df, x = "dyn", y = "Peak width", fill = "dyn",
  #         add = "boxplot", add.params = list(fill = "white")) + facet_wrap(~Stage) + scale_fill_manual(values=cols)
  ggecdf(plot_df, x = paste(type), color = "dyn") + facet_wrap(~Stage) + scale_color_manual(values=cols)
  #ggviolin(plot_df, x = "Stage", y = "Peak width", fill = "Stage",
  #         add = c("boxplot", "jitter"), add.params = list(fill = "white")) + facet_wrap(~dyn)
  #ggecdf(plot_df, x = paste(type), color = "Stage") + facet_wrap(~dyn)
  #ggline(plot_df, x = "Stage", y = paste(type), color = "dyn",  add=c("mean_se")) + scale_color_manual(values=cols)
  #ggline(plot_df, x = "Stage", y = paste(type), color = "dyn",  add=c("mean_se")) + scale_color_manual(values=cols) + facet_wrap(~dyn)
}
lapply(types, plot_chip_diffs, groups="rna")
lapply(types, plot_chip_diffs, groups="chip")
```

