---
title: "Meghana H3K4me3 Maintenance - 03 Dynamics analysis"
output: html_notebook
---

##Load categories
```{r}
clustered_groups = TRUE

if(clustered_groups){
  load("rna_data_clustered.RData")
  load("chip_data_clustered.RData")
} else {
  load("rna_data.RData")
  load("chip_data.RData")
}
load("h3k4me3_data_log.RData")
```

##Dotplot
```{r message=FALSE, warning=FALSE}
library(ggpubr)

remove_ND_LLLL <- FALSE

rna_ordered <- rna_dyns
chip_ordered <- chip_dyns
if(!clustered_groups){
  rna_ordered <- rna_dyns[c("Monly", "Ponly", "MPonly", "MZonly", "PZonly", "MPZ", "Zonly", "ND")]
  chip_ordered <- chip_dyns[c("H_L_L_L", "L_H_L_L",  "H_H_L_L", "H_L_H_L", "L_H_H_L", "H_H_H_L", "H_L_L_H", "H_H_L_H", "H_L_H_H", "L_H_H_H", "H_H_H_H","L_H_L_H",  "L_L_H_H", "L_L_H_L", "L_L_L_H", "L_L_L_L")]
}
if(remove_ND_LLLL){
  rna_ordered <- rna_ordered[!names(rna_ordered) %in% c("ND")]
  chip_ordered <- chip_ordered[!names(chip_ordered) %in% c("L_L_L_L", "Absent")]
}

genesAbsolute <- lapply(chip_ordered, function(x){as.data.frame(lapply(rna_ordered, function(y){length(intersect(x, y))}))})
genesAbsolute <- do.call(rbind, genesAbsolute)

fisher_p <- function(row, column){
  mat = genesAbsolute
  fisher_mat <- matrix(c(mat[row, column], sum(mat[-row, column]), sum(mat[row, -column]), sum(mat[-row, -column])), nrow=2)
  p_val <- fisher.test(fisher_mat)$p.value
  return(max(p_val, (1e-300)))
}

p_mat = data.frame(matrix(NA, nrow = nrow(genesAbsolute), ncol = ncol(genesAbsolute)), row.names = rownames(genesAbsolute))
colnames(p_mat) = colnames(genesAbsolute)

for (row in 1:nrow(p_mat)){
  for (col in 1:ncol(p_mat)){
    p_mat[row, col] <- fisher_p(row, col)
  }
}

p_mat = -log10(p_mat)

## Sort by similarity
#p_mat[p_mat < (-log10(0.05))] <- 0
#h3k4me3_dist<-dist(p_mat, method="euclidean")
#h3k4me3_clust<-hclust(h3k4me3_dist, method='complete')

#rna_dist<-dist(t(p_mat), method="euclidean")
#rna_clust<-hclust(rna_dist, method='complete')

#p_mat <- p_mat[h3k4me3_clust$order, rna_clust$order]

p_mat[p_mat < (-log10(0.05))] <- NA
#p_mat <- p_mat[rowSums(is.na(p_mat)) != ncol(p_mat), ] # remove empty rows
#p_mat <- p_mat[!rownames(p_mat) %in% c("L_L_L_L", "Absent"), colnames(p_mat) != "ND"] # not-detected does not mean not expressed (very uncertain sets)

my_cols <- c("#6A00A8FF", "#FCA636FF", "#F0F921FF", "#F0F921FF")
ggballoonplot(p_mat, fill="value") +
                      theme_light() + labs(x="RNA expression dynamics", y=paste0("H3K4me3 TSS dynamics\n", "[Spermatid, Sperm, Pre-ZGA, ZGA]")) +
                      scale_fill_gradientn(colors = my_cols, values=c(0, 0.05, 0.5, 1), breaks=c(0, 2, 20, 50, 100, 200)) + guides(size=guide_legend(title="-log10(Fisher independence p value)"), fill=guide_legend(title="-log10(Fisher independence p value)")) + scale_size(range = c(0, 10), breaks =c(0, 2, 20, 50, 100, 200))
```

# Peak shape comparison
```{r fig.height=6, fig.width=8}
dyn = rna_dyns
cols = cols_rnadyns

label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}
plot_peak <- function(name){
  stage_raw <- data.frame(chip_norm_mats[[paste(name)]])
  stage_raw$dyn <- sapply(rownames(stage_raw), label_dyn, dyns = dyn)
  stage_raw$gene <- rownames(stage_raw)
  melted <- melt(stage_raw)
  colnames(melted) <- c("dynamics", "Gene", "Genomic location", "Coverage")
  rna_plot <- ggline(melted, x = "Genomic location", y = "Coverage",
   add = "mean_se", conf.int = TRUE, color="dynamics") + scale_color_manual(values=cols) + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + ggtitle(name)
}

lapply(stages, plot_peak)

```

#Overall peak analysis
```{r}
type = "peak.width"
dyn = chip_dyns
cols = cols_chipdyns

library(ggpubr)
require(reshape2)
mask_peak <- function(df){
  df$promoter.enrich[!df$peak] <- NA
  df$promoter.max[!df$peak] <- NA
  df$promoter.mean[!df$peak] <- NA
  return(df)
}
masked_dfs <- lapply(chip_dfs, mask_peak)
plot_df <- do.call(cbind, masked_dfs)
plot_df <- plot_df[, grep(type, colnames(plot_df))]
plot_df$genes <- allgenes$gene_id
plot_df <- melt(plot_df)
colnames(plot_df) <- c("Gene","Stage",paste(type))  
plot_df <- plot_df[!is.na(plot_df[,type]),]
ggdensity(data=plot_df, x=paste(type), fill = "Stage", add_density = TRUE) #+ facet_wrap(~Stage)
ggecdf(data=plot_df, x=paste(type), color = "Stage")
```

#Differences in Chip groups
```{r fig.height=8, fig.width=8}
label_dyn <- function(gene, dyns){for(i in 1:length(dyns)){if(any(gene %in% dyns[[i]])){return(names(dyns)[i])}}; return(NA)}

## Chip dyns
plot_df$dyn <- sapply(plot_df$Gene, label_dyn, dyns = dyn)
#ggviolin(plot_df, x = "dyn", y = "Peak width", fill = "dyn",
#         add = "boxplot", add.params = list(fill = "white")) + facet_wrap(~Stage) + scale_fill_manual(values=cols)
ggecdf(plot_df, x = paste(type), color = "dyn") + facet_wrap(~Stage) + scale_color_manual(values=cols)
#ggviolin(plot_df, x = "Stage", y = "Peak width", fill = "Stage",
#         add = c("boxplot", "jitter"), add.params = list(fill = "white")) + facet_wrap(~dyn)
ggecdf(plot_df, x = paste(type), color = "Stage") + facet_wrap(~dyn)
ggline(plot_df, x = "Stage", y = paste(type), color = "dyn",  add=c("mean_se")) + scale_color_manual(values=cols)
ggline(plot_df, x = "Stage", y = paste(type), color = "dyn",  add=c("mean_se")) + scale_color_manual(values=cols) + facet_wrap(~dyn)
```

