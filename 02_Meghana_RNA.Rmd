---
title: "Meghana H3K4me3 Maintenance - 02 RNA-Seq analysis"
output: html_notebook
---

##Settings
```{r}
clustered_rna_groups = TRUE
rna_clustering <- list(GS = c("Monly", "Ponly", "MPonly"), GZ = c("MZonly", "PZonly", "MPZ"), ZS = "Zonly", ND = "ND")
cols_rna_clusters <- c(GS="#1B9E77", GZ="#D95F02", ZS = "#7570B3", ND = "#666666")
```

## Load Teperek TPM
```{r message=FALSE, warning=FALSE}
detected_thr = 5
library(Seurat)
library(SummarizedExperiment)

teperek_se <- readRDS("~/Documents/PhD/01_Projects/NT/Meghana_H3K4me3/Tobias data/meghana_rnaseq/GSE75164/se.rds")
teperek <- as.data.frame(assays(teperek_se)$tpms)
teperek$name = rowData(teperek_se)$name
teperek <- teperek[!duplicated(teperek$name),]

spermatid.detected <- teperek[teperek[,"GSM1944414"] > detected_thr & teperek[,"GSM1944415"] > detected_thr & teperek[,"GSM1944416"] > detected_thr, "name"]
spermatid.detected <- unique(spermatid.detected)
```

##Load dataset: Egg + Nascent (Chen)
```{r}
chen_se <- readRDS("~/Documents/PhD/01_Projects/NT/Meghana_H3K4me3/Tobias data/meghana_rnaseq/GSE201835/se.rds")
G_thr = 5
Z_thr = 5

chen <- as.data.frame(assays(chen_se)$tpms)
chen$name = rowData(chen_se)$name
chen <- chen[!duplicated(chen$name),]
 
egg.detected <- chen[chen[,"GSM6076970"] > G_thr & chen[,"GSM6076971"] > G_thr, "name"]
egg.detected <- unique(egg.detected)
 
zga_nascent.6hpf_stringent = (chen[,"GSM6076952"] - chen[,"GSM6076950"]) > Z_thr & (chen[,"GSM6076953"] - chen[,"GSM6076951"]) > Z_thr &     
                    (chen[,"GSM6076976"] - chen[,"GSM6076974"]) > Z_thr & (chen[,"GSM6076977"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.7hpf_stringent = (chen[,"GSM6076954"] - chen[,"GSM6076950"]) > Z_thr & (chen[,"GSM6076955"] - chen[,"GSM6076951"]) > Z_thr & 
                    (chen[,"GSM6076978"] - chen[,"GSM6076974"]) > Z_thr & (chen[,"GSM6076979"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.8hpf_stringent = (chen[,"GSM6076956"] - chen[,"GSM6076950"]) > Z_thr & (chen[,"GSM6076957"] - chen[,"GSM6076951"]) > Z_thr &
                    (chen[,"GSM6076980"] - chen[,"GSM6076974"]) > Z_thr & (chen[,"GSM6076981"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.9hpf_stringent = (chen[,"GSM6076958"] - chen[,"GSM6076950"]) > Z_thr & (chen[,"GSM6076959"] - chen[,"GSM6076951"]) > Z_thr & 
                    (chen[,"GSM6076982"] - chen[,"GSM6076974"]) > Z_thr & (chen[,"GSM6076983"] - chen[,"GSM6076975"]) > Z_thr
 
zga_nascent.detected_stringent <- zga_nascent.6hpf_stringent | zga_nascent.7hpf_stringent | zga_nascent.8hpf_stringent | zga_nascent.9hpf_stringent
zga_nascent.detected_stringent <- unique(chen[zga_nascent.detected_stringent, "name"])
 
zga_nascent.6hpf_lenient = (chen[,"GSM6076952"] - chen[,"GSM6076950"]) > Z_thr | (chen[,"GSM6076953"] - chen[,"GSM6076951"]) > Z_thr |     
                    (chen[,"GSM6076976"] - chen[,"GSM6076974"]) > Z_thr | (chen[,"GSM6076977"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.7hpf_lenient = (chen[,"GSM6076954"] - chen[,"GSM6076950"]) > Z_thr | (chen[,"GSM6076955"] - chen[,"GSM6076951"]) > Z_thr | 
                    (chen[,"GSM6076978"] - chen[,"GSM6076974"]) > Z_thr | (chen[,"GSM6076979"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.8hpf_lenient = (chen[,"GSM6076956"] - chen[,"GSM6076950"]) > Z_thr | (chen[,"GSM6076957"] - chen[,"GSM6076951"]) > Z_thr |
                    (chen[,"GSM6076980"] - chen[,"GSM6076974"]) > Z_thr | (chen[,"GSM6076981"] - chen[,"GSM6076975"]) > Z_thr
zga_nascent.9hpf_lenient = (chen[,"GSM6076958"] - chen[,"GSM6076950"]) > Z_thr | (chen[,"GSM6076959"] - chen[,"GSM6076951"]) > Z_thr | 
                    (chen[,"GSM6076982"] - chen[,"GSM6076974"]) > Z_thr | (chen[,"GSM6076983"] - chen[,"GSM6076975"]) > Z_thr
 
zga_nascent.detected_lenient <- zga_nascent.6hpf_lenient | zga_nascent.7hpf_lenient | zga_nascent.8hpf_lenient | zga_nascent.9hpf_lenient
zga_nascent.detected_lenient <- unique(chen[zga_nascent.detected_lenient, "name"])
```

###Detected genes at each stage
```{r}
rna_genes <- intersect(unique(union(chen$name, teperek$name)), allgenes$gene_id)
spermatid.detected <- spermatid.detected[spermatid.detected %in% rna_genes]
egg.detected <- egg.detected[egg.detected %in% rna_genes]
zga_nascent.detected_stringent <- zga_nascent.detected_stringent[zga_nascent.detected_stringent %in% rna_genes]
zga_nascent.detected_lenient <- zga_nascent.detected_lenient[zga_nascent.detected_lenient %in% rna_genes]
```

##Definition of dynamic groups
```{r}
rna_names_complete <- c("Monly", "Ponly", "Zonly", "MPonly", "MZonly", "PZonly", "MPZ", "ND")
Monly <- setdiff(setdiff(egg.detected, spermatid.detected), zga_nascent.detected_lenient)
Zonly <- setdiff(setdiff(zga_nascent.detected_stringent, egg.detected), spermatid.detected)
Ponly <-  setdiff(setdiff(spermatid.detected, zga_nascent.detected_lenient), egg.detected)
MZonly <- setdiff(intersect(egg.detected, zga_nascent.detected_stringent), spermatid.detected)
MPonly <- setdiff(intersect(egg.detected, spermatid.detected), zga_nascent.detected_lenient)
PZonly <- setdiff(intersect(spermatid.detected, zga_nascent.detected_stringent), egg.detected)
MPZ <- intersect(intersect(egg.detected, spermatid.detected), zga_nascent.detected_stringent)
ND <- setdiff(setdiff(setdiff(allgenes$gene_id,egg.detected), spermatid.detected), zga_nascent.detected_lenient)

if(clustered_rna_groups){
  rna_dyns <- lapply(rna_clustering, function(cluster){unlist(sapply(cluster, function(dyn_name){get(dyn_name)}), use.names = FALSE)})
  cols_rnadyns = cols_rna_clusters
} else {
  cols_rnadyns = c(Monly="#1B9E77", Ponly="#D95F02", Zonly = "#7570B3", MPonly = "#E7298A", MZonly = "#66A61E", PZonly = "#E6AB02", MPZ = "#A6761D", ND = "#666666")
  rna_dyns <- list("Monly" = Monly, "Ponly" = Ponly, "Zonly" = Zonly, "MPonly" = MPonly, "MZonly" = MZonly, "PZonly" = PZonly, "MPZ"= MPZ, "ND"= ND)
}

rna_dyns_sizes = unlist(lapply(rna_dyns, function(x) length(x)))
```

## Save data
```{r}
if(clustered_rna_groups){
  save(rna_dyns, cols_rnadyns, file="rna_data_clustered.RData")
} else {
  save(rna_dyns, cols_rnadyns, file="rna_data.RData")
}
```


##Venn diagram of RNA dynamics
```{r}
remove_ND <- TRUE

groups <- names(rna_dyns)
if(remove_ND){groups <- groups[!groups %in% c("ND")]}

plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("topright", title="RNA dynamics",
   groups, fill=cols_rnadyns[groups], horiz=FALSE)

library(eulerr)
if(clustered_rna_groups){
  euler_cols <- setNames(rep("#d3d3d3", 8), rna_names_complete)
  for(i in 1:length(rna_clustering)){
    cluster <- rna_clustering[[i]]
    for(dynamic in cluster){
      euler_cols[dynamic]=cols_rnadyns[names(rna_clustering)[i]]
    }
  }
} else {
  euler_cols <- cols_rnadyns
}
plot(euler(c("Egg"=length(Monly), "Spermatid"=length(Ponly), "ZGA"=length(Zonly),
           "Egg&Spermatid"=length(MPonly), "Egg&ZGA"=length(MZonly), "Spermatid&ZGA"=length(PZonly), "Egg&Spermatid&ZGA"=length(MPZ))),
     quantities = TRUE,fills=unlist(euler_cols))
plot(venn(c("Egg"=length(Monly), "Spermatid"=length(Ponly), "ZGA"=length(Zonly),
           "Egg&Spermatid"=length(MPonly), "Egg&ZGA"=length(MZonly), "Spermatid&ZGA"=length(PZonly), "Egg&Spermatid&ZGA"=length(MPZ))),
     quantities = TRUE,fills=unlist(euler_cols))
```
###Combine and transform TPM data 
```{r}
hm_data.spermatid <- data.frame(Spermatid = rowMeans(cbind(teperek[,"GSM1944414"], teperek[,"GSM1944415"], teperek[,"GSM1944416"])))
rownames(hm_data.spermatid) <- teperek[, "name"]
hm_data.egg <- data.frame(Egg = rowMeans(cbind(chen[,"GSM6076970"], chen[,"GSM6076971"])))
rownames(hm_data.egg) <- chen[, "name"]
hm_data.zga <- data.frame(T6hpf = rowMeans(cbind(chen[,"GSM6076952"], chen[,"GSM6076953"])),# chen[,"GSM6076976"], chen[,"GSM6076977"])), 
                     T7hpf = rowMeans(cbind(chen[,"GSM6076954"], chen[,"GSM6076955"])),# chen[,"GSM6076978"], chen[,"GSM6076979"])),
                     T8hpf = rowMeans(cbind(chen[,"GSM6076956"], chen[,"GSM6076957"])),#, chen[,"GSM6076980"], chen[,"GSM6076981"])),
                     T9hpf = rowMeans(cbind(chen[,"GSM6076958"], chen[,"GSM6076959"])))#, chen[,"GSM6076982"], chen[,"GSM6076983"])))
rownames(hm_data.zga) <- chen[, "name"]

zga_nascent.5hpf <- rowMeans(cbind(chen[,"GSM6076950"], chen[,"GSM6076951"]))#, chen[,"GSM6076974"], chen[,"GSM6076975"]))
hm_data.zga <- apply(hm_data.zga, 2, function(x) x - zga_nascent.5hpf)
hm_data.zga[hm_data.zga<0] <- 0

tpms_ct <- merge(hm_data.spermatid, cbind(hm_data.egg, hm_data.zga), by = "row.names", all = TRUE)
rownames(tpms_ct) <- tpms_ct$Row.names
tpms_ct <- tpms_ct[rownames(tpms_ct) %in% unlist(rna_dyns),!(names(tpms_ct) %in% "Row.names")]

for (rna_dyn in names(rna_dyns)){
  tpms_ct[unlist(rna_dyns[rna_dyn]), "Category"] <- rna_dyn
}
tpms_ct$Category <- factor(tpms_ct$Category, levels = names(rna_dyns))
tpms_ct <- replace(tpms_ct, is.na(tpms_ct), 0)
```

###RNA groups heatmap
```{r, fig.width=6, fig.height=8}
library(ComplexHeatmap)
cols_biscale <- c("lightgoldenrod1", "chocolate3", "firebrick4")
remove_ND <- TRUE

tpms_ct_plot <- tpms_ct
if(remove_ND){tpms_ct_plot <- tpms_ct_plot[!tpms_ct$Category %in% c("ND"),]}

hm_values.log <- as.matrix(log2(tpms_ct_plot[ ,1:6]+1))

col_split = factor(c(rep("Spermatid", 1), rep("Egg", 1), rep("ZGA", 4)))
h1 <- Heatmap(hm_values.log, row_split = tpms_ct_plot$Category, name="log2(TPM+1)",
               cluster_columns = FALSE, cluster_rows = FALSE, show_row_names = FALSE, column_split = col_split, row_title_rot = 0, cluster_row_slices = FALSE,
               col = cols_biscale, row_title_gp = gpar(cex=0.5), 
                  left_annotation = rowAnnotation(
                    Category = tpms_ct_plot$Category,
                    col = list(Category = unlist(cols_rnadyns))))

draw(h1)

#pdf("~/Downloads/RNAGenegroups_Heatmap.pdf", width=4, height=8)
#draw(h1)
#dev.off()
```

###RNA groups boxplots
```{r}
library(tidyr)
library(ggplot2)
remove_ND <- FALSE

tpms_ct_plot <- tpms_ct
if(remove_ND){tpms_ct_plot <- tpms_ct_plot[!tpms_ct$Category %in% c("ND"),]}
bp_data <- tpms_ct_plot %>% pivot_longer(cols=c("Spermatid", "Egg", "T6hpf", "T7hpf", "T8hpf", "T9hpf"), names_to='Time', values_to='Expression')


boxes <- ggplot(bp_data, aes(x=Time, y=log2(Expression+1), fill=Category)) + 
  geom_boxplot() + 
  scale_fill_manual(values=cols_rnadyns) +
  theme_minimal() + 
  labs(y = "log2(TPM+1)") +  
  facet_wrap(~Category, scale="free", ncol = 4) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept=log(5+1, 2), linetype="dashed", color = "snow4")
boxes
#ggsave(boxes, file = "/Users/meghana.oak/Documents/EPIGRS_PhD/NGS_data_sorted/Plots/Fig2/iv_RNAGenegroups_Boxplots.tiff", width = 22, height = 12, units = "cm")
```

###GO analysis on each gene group
```{r, fig.width=8, fig.height=12}
library(clusterProfiler)
library(org.Xl.eg.db)
library(simplifyEnrichment)
library(gridExtra)
library(grid)
Xl_ENTREZ <- read.delim("~/Documents/PhD/01_Projects/NT/Meghana_H3K4me3/NGS_data_sorted/Genome_Xl10.1/GenePageLaevisEntrezGeneUnigeneMapping.txt", header = FALSE)

go_enrichment <- function(data) {
  entrez <- Xl_ENTREZ[Xl_ENTREZ$V2 %in% data, ] 
  colnames(entrez) <- c("Xenbase ID", "Gene symbol", "Entrez ID", "Xl ID unknown")
  GO <- enrichGO(entrez$`Entrez ID`, OrgDb = org.Xl.eg.db, ont = "BP", readable = TRUE)
  return(GO)
}
plot_go <- function(enrichGO, name){
  dp <- dotplot(enrichGO)
  cn <- cnetplot(enrichGO)
  grid.arrange(dp, cn, top=name, nrow=2)
}

for (i in 1:length(rna_dyns)){
  rna_GO <- go_enrichment(rna_dyns[[i]])
  if(sum(rna_GO@result$p.adjust < rna_GO@pvalueCutoff)){
    plot_go(rna_GO, names(rna_dyns)[i])
  }
}
```

```{r message=FALSE, warning=FALSE}
for (i in 1:length(rna_dyns)){
  enrichGO <- go_enrichment(rna_dyns[[i]])
  hits <- enrichGO@result$ID[enrichGO@result$p.adjust<0.05]
  if(length(hits)>1){simplifyGO(GO_similarity(hits, db = 'org.Xl.eg.db'), column_title = names(rna_dyns[i]))}
}
```
```{r fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
p_adj = 0.01
go_list <- lapply(rna_dyns, go_enrichment)
go_list <- go_list[unlist(lapply(go_list, function(enrichGO){sum(enrichGO@result$p.adjust<p_adj) > 0}))]
go_list <- lapply(go_list, function(x) x$ID[x$p.adjust < p_adj])
simplifyGOFromMultipleLists(go_list, padj_cutoff=p_adj, db = 'org.Xl.eg.db', ont = "BP")
```





